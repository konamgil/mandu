import type { RouteSpec } from "../spec/schema";

export function generateApiHandler(route: RouteSpec): string {
  // slotModule이 있으면 slot을 호출하는 버전 생성
  if (route.slotModule) {
    return generateApiHandlerWithSlot(route);
  }

  return `// Generated by Mandu - DO NOT EDIT DIRECTLY
// Route ID: ${route.id}
// Pattern: ${route.pattern}

import type { Request } from "bun";

export default function handler(req: Request, params: Record<string, string>): Response {
  return Response.json({
    status: "ok",
    routeId: "${route.id}",
    pattern: "${route.pattern}",
    timestamp: new Date().toISOString(),
  });
}
`;
}

export function generateApiHandlerWithSlot(route: RouteSpec): string {
  const slotImportPath = computeSlotImportPath(route.slotModule!, "apps/server/generated/routes");
  const logicFunctionName = `${route.id}Logic`;

  return `// Generated by Mandu - DO NOT EDIT DIRECTLY
// Route ID: ${route.id}
// Pattern: ${route.pattern}
// Slot Module: ${route.slotModule}

import type { Request } from "bun";
import { ${logicFunctionName} } from "${slotImportPath}";

export default async function handler(
  req: Request,
  params: Record<string, string>
): Promise<Response> {
  try {
    const result = await ${logicFunctionName}(req, params);
    return Response.json(result);
  } catch (error) {
    console.error(\`[${route.id}] Handler error:\`, error);
    return Response.json(
      { status: "error", message: "Internal server error" },
      { status: 500 }
    );
  }
}
`;
}

export function generateSlotLogic(route: RouteSpec): string {
  const logicFunctionName = `${route.id}Logic`;
  const resultTypeName = `${capitalize(route.id)}Result`;

  return `// Slot logic for route: ${route.id}
// Pattern: ${route.pattern}
// 이 파일에서 비즈니스 로직을 구현하세요.

import type { Request } from "bun";

export interface ${resultTypeName} {
  status: "ok" | "error";
  data?: unknown;
  message?: string;
}

export async function ${logicFunctionName}(
  req: Request,
  params: Record<string, string>
): Promise<${resultTypeName}> {
  const method = req.method;

  // TODO: 비즈니스 로직 구현
  switch (method) {
    case "GET":
      return {
        status: "ok",
        data: { routeId: "${route.id}", message: "GET 로직 미구현" },
      };

    case "POST":
      return {
        status: "ok",
        data: { routeId: "${route.id}", message: "POST 로직 미구현" },
      };

    default:
      return {
        status: "error",
        message: \`Method \${method} not allowed\`,
      };
  }
}
`;
}

function computeSlotImportPath(slotModule: string, fromDir: string): string {
  // slotModule: "apps/server/slots/users.logic.ts"
  // fromDir: "apps/server/generated/routes"
  // result: "../../slots/users.logic"

  const slotParts = slotModule.replace(/\\/g, "/").split("/");
  const fromParts = fromDir.replace(/\\/g, "/").split("/");

  // Find common prefix length
  let commonLength = 0;
  while (
    commonLength < slotParts.length &&
    commonLength < fromParts.length &&
    slotParts[commonLength] === fromParts[commonLength]
  ) {
    commonLength++;
  }

  // Calculate relative path
  const upCount = fromParts.length - commonLength;
  const relativeParts = slotParts.slice(commonLength);
  const ups = Array(upCount).fill("..");

  let result = [...ups, ...relativeParts].join("/");

  // Remove .ts extension
  result = result.replace(/\.ts$/, "");

  return result;
}

export function generatePageComponent(route: RouteSpec): string {
  const pageName = capitalize(route.id);
  return `// Generated by Mandu - DO NOT EDIT DIRECTLY
// Route ID: ${route.id}
// Pattern: ${route.pattern}

import React from "react";

interface Props {
  params: Record<string, string>;
}

export default function ${pageName}Page({ params }: Props): React.ReactElement {
  return React.createElement("div", null,
    React.createElement("h1", null, "${pageName} Page"),
    React.createElement("p", null, "Route ID: ${route.id}"),
    React.createElement("p", null, "Pattern: ${route.pattern}")
  );
}
`;
}

function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
