import { listChanges, getChangeStats } from "@mandujs/core";
import { getRootDir } from "../../util/fs";

export async function changeList(): Promise<boolean> {
  const rootDir = getRootDir();

  console.log(`ğŸ¥Ÿ Mandu Change List\n`);

  try {
    const changes = await listChanges(rootDir);
    const stats = await getChangeStats(rootDir);

    if (changes.length === 0) {
      console.log(`ğŸ“­ ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤`);
      console.log(`\nğŸ’¡ ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘: bunx mandu change begin`);
      return true;
    }

    // í†µê³„
    console.log(`ğŸ“Š í†µê³„:`);
    console.log(`   ì´ ê¸°ë¡: ${stats.total}ê°œ`);
    console.log(`   í™œì„±: ${stats.active}ê°œ | í™•ì •: ${stats.committed}ê°œ | ë¡¤ë°±: ${stats.rolledBack}ê°œ`);
    console.log(`   ìŠ¤ëƒ…ìƒ·: ${stats.snapshotCount}ê°œ\n`);

    // ìµœê·¼ ê¸°ë¡ (ìµœì‹  ìˆœ)
    console.log(`ğŸ“œ ë³€ê²½ ì´ë ¥:`);

    const sortedChanges = [...changes].reverse(); // ìµœì‹  ìˆœ

    for (const change of sortedChanges) {
      const statusIcon =
        change.status === "active"
          ? "ğŸ”„"
          : change.status === "committed"
            ? "âœ…"
            : "â†©ï¸";

      const date = new Date(change.createdAt).toLocaleString();

      console.log(`   ${statusIcon} ${change.id}`);
      console.log(`      ìƒíƒœ: ${change.status}`);
      console.log(`      ì‹œê°„: ${date}`);
      if (change.message) {
        console.log(`      ë©”ì‹œì§€: ${change.message}`);
      }
      if (change.autoGenerated) {
        console.log(`      ìƒì„±: Auto-correct`);
      }
      console.log("");
    }

    return true;
  } catch (error) {
    console.error(`âŒ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: ${error instanceof Error ? error.message : String(error)}`);
    return false;
  }
}
