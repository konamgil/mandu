// Generated by Mandu - DO NOT EDIT DIRECTLY
// Route ID: todos-api
// Pattern: /api/todos
// Contract Module: spec/contracts/todos-api.contract.ts
// Slot Module: spec/slots/todos-api.slot.ts

import type { Request } from "bun";
import { ContractValidator, formatValidationErrors } from "@mandujs/core";
import contract from "../../../../spec/contracts/todos-api.contract";
import filling from "../../../../spec/slots/todos-api.slot";

const validator = new ContractValidator(contract);
const isDev = process.env.NODE_ENV !== "production";

export default async function handler(
  req: Request,
  params: Record<string, string>
): Promise<Response> {
  const method = req.method;

  // 1. Request Validation
  const reqValidation = await validator.validateRequest(req, method, params);
  if (!reqValidation.success) {
    return Response.json(
      formatValidationErrors(reqValidation.errors!),
      { status: 400 }
    );
  }

  // 2. Execute Filling
  const response = await filling.handle(req, params, {
    routeId: "todos-api",
    pattern: "/api/todos",
  });

  // 3. Response Validation (dev only)
  if (isDev && response.headers.get("content-type")?.includes("application/json")) {
    try {
      const cloned = response.clone();
      const body = await cloned.json();
      const resValidation = validator.validateResponse(body, response.status);
      if (!resValidation.success) {
        console.warn(
          "\x1b[33m[Mandu] Contract violation in response:\x1b[0m",
          "todos-api",
          resValidation.errors
        );
      }
    } catch {
      // Ignore JSON parse errors for non-JSON responses
    }
  }

  return response;
}
